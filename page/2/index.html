<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>Eric Li&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="Eric Li's Blog">
<meta property="og:url" content="http://ericculee.github.io/page/2/index.html">
<meta property="og:site_name" content="Eric Li's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eric Li's Blog">
    

    
        <link rel="alternate" href="/" title="Eric Li&#39;s Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81414009-1# enter the tracking ID for your Google Analytics', 'auto');
ga('send', 'pageview');

</script>
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Eric Li&#39;s Blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="https://www.linkedin.com/in/eric-peng-li-ab8286a9">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://media.licdn.com/mpr/mpr/shrinknp_400_400/AAEAAQAAAAAAAASiAAAAJDJiN2IzNDE4LTFiYTQtNDJjNS05ZTk5LWE1ODUyNTRiZTk0Zg.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="https://www.linkedin.com/in/eric-peng-li-ab8286a9">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://media.licdn.com/mpr/mpr/shrinknp_400_400/AAEAAQAAAAAAAASiAAAAJDJiN2IzNDE4LTFiYTQtNDJjNS05ZTk5LWE1ODUyNTRiZTk0Zg.jpg" />
            <h2 id="name">Eric Li</h2>
            <h3 id="title">Cloud &amp; Data Analytic Architect &amp; Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Beijing, China</span>
            <a id="follow" target="_blank" href="https://github.com/cuericlee">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                10
                <span>posts</span>
            </div>
            <div class="article-info-block">
                26
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/cuericlee" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://www.linkedin.com/in/eric-peng-li-ab8286a9" target="_blank" title="linkedin" class=tooltip>
                            <i class="fa fa-linkedin"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-Performance-Tuning-of-Spark-ML-Job" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/08/25/Performance-Tuning-of-Spark-ML-Job/">Performance Tuning of Spark ML Job</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/08/25/Performance-Tuning-of-Spark-ML-Job/">
            <time datetime="2016-08-25T15:10:46.000Z" itemprop="datePublished">2016-08-25</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/bigdata/">bigdata</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/bigdata/analytic/">analytic</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/bigdata/analytic/tech/">tech</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/machine-learning/">machine learning</a>, <a class="tag-link" href="/tags/performance/">performance</a>, <a class="tag-link" href="/tags/spark/">spark</a>, <a class="tag-link" href="/tags/tuning/">tuning</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><p>Spark Advanced Tuning course is designed for attendees of online course of Big Data University. This article discuss some common way to tuning an job of spark ML.</p>
<h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><p>Clone spark-ml-pipeline project</p>
<pre><code>clone git@github.com:big-data-university/spark-ml-pipeline.git
git checkout -b advanced
</code></pre><h3 id="Tuning"><a href="#Tuning" class="headerlink" title="Tuning"></a>Tuning</h3><h4 id="1-Change-parallelism-default-partition-number-of-RDD"><a href="#1-Change-parallelism-default-partition-number-of-RDD" class="headerlink" title="1. Change parallelism (default partition number of RDD)"></a>1. <strong>Change parallelism (default partition number of RDD)</strong></h4><h5 id="1-1-Default-core-number"><a href="#1-1-Default-core-number" class="headerlink" title="1.1 Default core number"></a>1.1 Default core number</h5><p><code>val conf = new SparkConf().setAppName(&quot;CrossValidation Pipeline&quot;).setMaster(&quot;local[4]&quot;) //Using 2 core running on local</code></p>
<p><a href="https://gist.github.com/cuericlee/3cdc51489c01e1add766f199ef260a34#file-pipline-scala-L51" target="_blank" rel="external">core number</a></p>
<h5 id="1-2-Default-parallelism"><a href="#1-2-Default-parallelism" class="headerlink" title="1.2 Default parallelism"></a>1.2 Default parallelism</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">*Increase parallelism, local default = number of core. e.g. 8 on mac</div><div class="line">*/</div><div class="line"></div><div class="line">conf.set(&quot;spark.default.parallelism&quot;, &quot;4&quot;)</div></pre></td></tr></table></figure>
<h5 id="1-3-Repartition-RDD-to-change-parallelism-on-the-fly"><a href="#1-3-Repartition-RDD-to-change-parallelism-on-the-fly" class="headerlink" title="1.3 Repartition RDD to change parallelism on the fly"></a>1.3 Repartition RDD to change parallelism on the fly</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">train.repartition(1)</div><div class="line">    </div><div class="line">train.repartition(10)</div></pre></td></tr></table></figure>
<h4 id="2-Efficient-Serialize"><a href="#2-Efficient-Serialize" class="headerlink" title="2. Efficient Serialize"></a>2. <strong>Efficient Serialize</strong></h4><ul>
<li>Enable Kryoserilizer for efficient persistent/cache and memory usage</li>
</ul>
<p><code>conf.set(&quot;spark.serializer&quot;, &quot;org.apache.spark.serializer.KryoSerializer&quot;)</code></p>
<ul>
<li>Enable library of kryo in build.sbt</li>
</ul>
<p><code>libraryDependencies += &quot;com.esotericsoftware&quot; %% &quot;kryo&quot; % &quot;4.0.0&quot;</code></p>
<ul>
<li>RDD persistent/cache</li>
</ul>
<p><code>RDD.persist(StorageLevel.MEMORY_ONLY_SER)</code></p>
<h4 id="3-Reduce-times-of-full-GC"><a href="#3-Reduce-times-of-full-GC" class="headerlink" title="3. Reduce times of full GC"></a><strong>3. Reduce times of full GC</strong></h4><h5 id="3-1-Enable-GC-verbose-output-for-analysis"><a href="#3-1-Enable-GC-verbose-output-for-analysis" class="headerlink" title="3.1 Enable GC verbose output for analysis"></a>3.1 Enable GC verbose output for analysis</h5><p>Add JVM parameters to enable verbose and GC detail <code>-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedOops</code></p>
<pre><code>/**
 * Enable GC trace for executor
 */
conf.set(&quot;spark.executor.extraJavaOptions&quot;, &quot;-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedOops&quot;)
</code></pre><h5 id="3-2-Determine-number-of-full-GC-during-whole-execution-using-standard-output"><a href="#3-2-Determine-number-of-full-GC-during-whole-execution-using-standard-output" class="headerlink" title="3.2 Determine number of full GC during whole execution using standard output."></a>3.2 Determine number of full GC during whole execution using standard output.</h5><pre><code>cat &lt;your_log_file&gt;|grep &quot;Full GC&quot;|wc -l
</code></pre><h5 id="3-3-Evaluate-size-of-RDD-partition"><a href="#3-3-Evaluate-size-of-RDD-partition" class="headerlink" title="3.3 Evaluate size of RDD partition"></a>3.3 Evaluate size of RDD partition</h5><ol>
<li>dfs.block.size - The default value in Hadoop 2.0 is 128MB. In the local mode the corresponding parameter is fs.local.block.size (Default value 32MB). It defines the default partition size.</li>
</ol>
<ol>
<li><p>numPartitions - The default value is 0 which effectively defaults to 1. This is a parameter you pass to the sc.textFile(inputPath,numPartitions) method. It is used to decrease the partition size (increase the number of partitions) from the default value defined by dfs.block.size</p>
</li>
<li><p>mapreduce.input.fileinputformat.split.minsize - The default value is 1 byte. It is used to increase the partition size (decrease the number of partitions) from the default value defined by dfs.block.size</p>
</li>
</ol>
<pre><code>println(&quot;fs.local.block.size: &quot; + sc.getConf.get(&quot;fs.local.block.size&quot;))
println(&quot;mapreduce.input.fileinputformat.split.minsize: &quot; + sc.getConf.get(&quot;mapreduce.input.fileinputformat.split.minsize&quot;))
println(&quot;size of trainRDD: &quot; + SizeEstimator.estimate(train) + &quot; Byte&quot;)
println(&quot;size of testRDD: &quot; + SizeEstimator.estimate(test) + &quot; Byte&quot;)
</code></pre><h5 id="3-4-Adjust-parallelism-to-reduce-number-of-full-GC"><a href="#3-4-Adjust-parallelism-to-reduce-number-of-full-GC" class="headerlink" title="3.4 Adjust parallelism to reduce number of full GC"></a>3.4 Adjust parallelism to reduce number of full GC</h5><ol>
<li>Reduce parallelism when size of RDD &lt; block size</li>
<li>Increase parallelism when of RDD &gt; block size</li>
</ol>
<h5 id="3-5-Increase-java-heap-for-both-driver-JVM-and-executor-to-reduce-GC"><a href="#3-5-Increase-java-heap-for-both-driver-JVM-and-executor-to-reduce-GC" class="headerlink" title="3.5 Increase java heap for both driver JVM and executor to reduce GC"></a>3.5 Increase java heap for both driver JVM and executor to reduce GC</h5><pre><code>conf.set(&quot;spark.driver.memory&quot;, &quot;2G&quot;) // Increase java heap for driver, -Xmx is illegal setting

conf.set(&quot;spark.executor.memory&quot;, &quot;1G&quot;) //Increase to 2G per executor from default value 1G. -Xmx1G is illegal setting for spark executor.
</code></pre><h5 id="3-6-validate-number-of-full-GC-and-conclusion"><a href="#3-6-validate-number-of-full-GC-and-conclusion" class="headerlink" title="3.6 validate number of full GC and conclusion"></a>3.6 validate number of full GC and conclusion</h5><p>Conclusion: It is significantly to reduce the execution time after reducing number of full GC.</p>
<h4 id="4-Increase-instance-number-of-executor-in-the-cluster-env"><a href="#4-Increase-instance-number-of-executor-in-the-cluster-env" class="headerlink" title="4. Increase instance number of executor in the cluster env"></a><strong>4. Increase instance number of executor in the cluster env</strong></h4><p>Check the size and partition of RDD</p>
<p>When size of RDD &gt;&gt; block size and number partition &gt;&gt; executor * core, it is significant improve performance to increase instance number of executor allowed in the cluster.</p>
<pre><code>/**
 * Increase executor numbers to increase parallelism, only works for cluster env. standalone, yarn, mesos
 */
conf.set(&quot;spark.executor.instances&quot;, &quot;4&quot;)
</code></pre><h4 id="5-Reserve-as-much-as-possible-memory-for-executor-but-does-make-executor-overload"><a href="#5-Reserve-as-much-as-possible-memory-for-executor-but-does-make-executor-overload" class="headerlink" title="5. Reserve as much as possible memory for executor, but does make executor overload "></a><strong>5. Reserve as much as possible memory for executor, but does make executor overload </strong></h4><pre><code>conf.set(&quot;spark.executor.memory&quot;, &quot;1G&quot;) 
</code></pre><h3 id="All-in-one"><a href="#All-in-one" class="headerlink" title="All in one"></a>All in one</h3><script src="https://gist.github.com/cuericlee/3cdc51489c01e1add766f199ef260a34.js"></script>


        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://ericculee.github.io/2016/08/25/Performance-Tuning-of-Spark-ML-Job/" data-id="cj0dnea7w0005y1u09jusvxpm" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://ericculee.github.io/2016/08/25/Performance-Tuning-of-Spark-ML-Job/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://ericculee.github.io/2016/08/25/Performance-Tuning-of-Spark-ML-Job/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/">Research on Ubernetes (High availability zone) and federation clusters for Kubernetes</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/">
            <time datetime="2016-08-05T15:03:56.000Z" itemprop="datePublished">2016-08-05</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/tech/">tech</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/availability/">availability</a>, <a class="tag-link" href="/tags/container/">container</a>, <a class="tag-link" href="/tags/kubernetes/">kubernetes</a>, <a class="tag-link" href="/tags/ubernetes/">ubernetes</a>, <a class="tag-link" href="/tags/zone/">zone</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><ol>
<li><p>Multiple zone minion nodes share the same master node (api server, etcd and etc). Need to seriously considering the high availability of master node. Nodes is labeled by different zone and failure-domain to allow distribute workload across zones.</p>
</li>
<li><p>PV Affinity is used for zone awareness. But PV affinity is not ready. Most cloud providers (at least GCE and AWS) cannot attach their persistent volumes across zones.  Thus when a pod is being scheduled, if there is a volume<br>attached, that will dictate the zone.  This will be implemented using a new<br>scheduler predicate (a hard constraint): <code>VolumeZonePredicate</code>.<br>The PV is also labeled with the zone &amp; region it was created in. For version 1.3.4, dynamic persistent volumes are always created in the zone of the cluster master (here us-central1-a / us-west-2a); this will be improved in a future version (issue #23330.).   </p>
</li>
<li><p>Current kube-up.sh scripts depends on kube-up/kube-down/kube-push implementation and SDK of cloudprovider. gce and aws are supported well, but not for other cloudprovider today. (v1.3.4)</p>
</li>
<li><p>Alternative solution to setup an multiple availability zone with simple cloudprovider ubuntu/centos.</p>
<p> 4.1 Key spec</p>
<ul>
<li>share etcd</li>
<li>share flannel network</li>
<li>share docker registry</li>
<li><p>share apiserver. MASTER_INTERNAL_IP=172.20.0.9</p>
<p>4.2 Solution</p>
<blockquote>
<p>Create VM firslty, then kube-up.sh an ubuntu (centos) worker only to reuse the same master.</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h3 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h3><pre><code>pip install --upgrade aws-cli
</code></pre><h3 id="Init-install"><a href="#Init-install" class="headerlink" title="Init install"></a>Init install</h3><pre><code>curl -sS https://get.k8s.io | MULTIZONE=true KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2 NUM_NODES=1 bash
</code></pre><h3 id="Setup-an-multizone-cluster-on-aws"><a href="#Setup-an-multizone-cluster-on-aws" class="headerlink" title="Setup an multizone cluster on aws"></a>Setup an multizone cluster on aws</h3><ol>
<li><p>Setup 1 node from zone us-west-2</p>
<pre><code>MULTIZONE=true KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2a NUM_NODES=1 ./cluster/kube-up.sh
</code></pre></li>
<li><p>Add 1 node cluster from zone us-west-2a</p>
<pre><code>KUBE_USE_EXISTING_MASTER=true MULTIZONE=true KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2b NUM_NODES=1 KUBE_SUBNET_CIDR=172.20.1.0/24 MASTER_INTERNAL_IP=172.20.0.9 kubernetes/cluster/kube-up.sh
</code></pre></li>
<li><p>Nodes labels for availability zone</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubectl get nodes --show-labels</div><div class="line">NAME                                         STATUS     AGE       LABELS</div><div class="line">ip-172-20-0-31.us-west-2.compute.internal    NotReady   2d        beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.micro,beta.kubernetes.io/os=linux,failure-domain.beta.kubernetes.io/region=us-west-2,failure-domain.beta.kubernetes.io/zone=us-west-2a,kubernetes.io/hostname=ip-172-20-0-31.us-west-2.compute.internal</div><div class="line">ip-172-20-1-138.us-west-2.compute.internal   Ready      2d        beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.micro,beta.kubernetes.io/os=linux,failure-domain.beta.kubernetes.io/region=us-west-2,failure-domain.beta.kubernetes.io/zone=us-west-2b,kubernetes.io/hostname=ip-172-20-1-138.us-west-2.compute.internal</div></pre></td></tr></table></figure>
<h3 id="Create-PV-with-zone-affinity-provisioned-at-zone-of-master-node"><a href="#Create-PV-with-zone-affinity-provisioned-at-zone-of-master-node" class="headerlink" title="Create PV with zone affinity, provisioned at zone of master node"></a>Create PV with zone affinity, provisioned at zone of master node</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">kubectl create -f - &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  "kind": "PersistentVolumeClaim",</div><div class="line">  "apiVersion": "v1",</div><div class="line">  "metadata": &#123;</div><div class="line">    "name": "claim1",</div><div class="line">    "annotations": &#123;</div><div class="line">        "volume.alpha.kubernetes.io/storage-class": "foo"</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "spec": &#123;</div><div class="line">    "accessModes": [</div><div class="line">      "ReadWriteOnce"</div><div class="line">    ],</div><div class="line">    "resources": &#123;</div><div class="line">      "requests": &#123;</div><div class="line">        "storage": "1Gi"</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NAME                                       CAPACITY   ACCESSMODES   STATUS    CLAIM            REASON    AGE       LABELS</div><div class="line">pvc-feb20d75-593a-11e6-afe8-06d12fd78863   1Gi        RWO           Bound     default/claim1             42s       failure-domain.beta.kubernetes.io/region=us-west-2,failure-domain.beta.kubernetes.io/zone=us-west-2a</div></pre></td></tr></table></figure>
<h3 id="Destroy-multiple-zone-cluster"><a href="#Destroy-multiple-zone-cluster" class="headerlink" title="Destroy multiple-zone cluster"></a>Destroy multiple-zone cluster</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">KUBERNETES_PROVIDER=aws KUBE_USE_EXISTING_MASTER=true KUBE_AWS_ZONE=us-west-2b kubernetes/cluster/kube-down.sh</div><div class="line">KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2a kubernetes/cluster/kube-down.sh</div></pre></td></tr></table></figure>
<h3 id="Multiple-cluster-management"><a href="#Multiple-cluster-management" class="headerlink" title="Multiple cluster management"></a>Multiple cluster management</h3><p><a href="http://kubernetes.io/docs/admin/federation/" target="_blank" rel="external">Federation panel</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#Mandatory to build your own federation images with source code </div><div class="line">FEDERATION=true KUBE_RELEASE_RUN_TESTS=n make quick-release</div><div class="line"></div><div class="line">FEDERATION=true FEDERATION_PUSH_REPO_BASE=&lt;Your private registry&gt; ./build/push-federation-images.sh</div><div class="line"></div><div class="line">#Setup federation container, dns, router, lb, kubeconfig and federation namespace</div><div class="line"></div><div class="line">GOROOT=/root/go KUBE_ROOT=/root/k8s/src/k8s.io/kubernetes KUBERNETES_PROVIDER=aws DNS_ZONE_NAME=myfederation.aws FEDERATION_NAME=myfederation FEDERATION_PUSH_REPO_BASE=&lt;your private registry&gt; /root/k8s/src/k8s.io/kubernetes/federation/cluster/federation-up.sh</div><div class="line"></div><div class="line"></div><div class="line">GOROOT=/root/go KUBE_ROOT=/root/k8s/src/k8s.io/kubernetes KUBERNETES_PROVIDER=aws DNS_ZONE_NAME=myfederation.aws FEDERATION_NAME=myfederation FEDERATION_PUSH_REPO_BASE=&lt;your private registry&gt; /root/k8s/src/k8s.io/kubernetes/federation/cluster/federation-down.sh</div><div class="line"></div><div class="line">service &quot;federation-apiserver&quot; deleted</div><div class="line">secret &quot;default-token-k6v8j&quot; deleted</div><div class="line">secret &quot;federation-apiserver-kubeconfig&quot; deleted</div><div class="line">namespace &quot;federation&quot; deleted</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://ericculee.github.io/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/" data-id="cj0dnea89000ey1u0wjqa3ne1" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://ericculee.github.io/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://ericculee.github.io/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-scale-out-resource-vertically-by-resource-quota" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2016/08/02/scale-out-resource-vertically-by-resource-quota/">Scale out resource vertically by resource quota</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/08/02/scale-out-resource-vertically-by-resource-quota/">
            <time datetime="2016-08-02T10:22:01.000Z" itemprop="datePublished">2016-08-02</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/container/">container</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/qos/">qos</a>, <a class="tag-link" href="/tags/quota/">quota</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h3 id="Set-default-resource-quota-for-namespace"><a href="#Set-default-resource-quota-for-namespace" class="headerlink" title="Set default resource quota for namespace"></a>Set default resource quota for namespace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># kubectl describe quota --namespace=quota-example</div><div class="line"></div><div class="line">Name:           compute-resources</div><div class="line">Namespace:      quota-example</div><div class="line">Resource        Used    Hard</div><div class="line">--------        ----    ----</div><div class="line">limits.cpu      200m    2</div><div class="line">limits.memory   512Mi   2Gi</div><div class="line">pods            1       4</div><div class="line">requests.cpu    100m    1</div><div class="line">requests.memory 256Mi   1Gi</div></pre></td></tr></table></figure>
<h3 id="Deploy-pod-deployment-rs-to-namespace-then-deployment-will-use-default-resource-quota-without-explicit-specification"><a href="#Deploy-pod-deployment-rs-to-namespace-then-deployment-will-use-default-resource-quota-without-explicit-specification" class="headerlink" title="Deploy pod/deployment/rs to namespace, then deployment will use default resource quota without explicit specification."></a>Deploy pod/deployment/rs to namespace, then deployment will use default resource quota without explicit specification.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">kubectl run nginx --image=nginx --replicas=1 --namespace=quota-example</div><div class="line">deployment &quot;nginx&quot; created</div><div class="line">[root@cdsdev-radiant-0001 quota]# kubectl describe limits limits --namespace=quota-example</div><div class="line">Name:           limits</div><div class="line">Namespace:      quota-example</div><div class="line">Type            Resource        Min     Max     Default Request Default Limit   Max Limit/Request Ratio</div><div class="line">----            --------        ---     ---     --------------- -------------   -----------------------</div><div class="line">Container       cpu             -       -       100m            200m            -</div><div class="line">Container       memory          -       -       256Mi           512Mi           -</div></pre></td></tr></table></figure>
<p><code>kubectl describe rs  --namespace=quota-example</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Name:           nginx-2040093540</div><div class="line">Namespace:      quota-example</div><div class="line">Image(s):       nginx</div><div class="line">Selector:       pod-template-hash=2040093540,run=nginx</div><div class="line">Labels:         pod-template-hash=2040093540,run=nginx</div><div class="line">Replicas:       1 current / 1 desired</div><div class="line">Pods Status:    1 Running / 0 Waiting / 0 Succeeded / 0 Failed</div><div class="line">No volumes.</div><div class="line">Events:</div><div class="line">  FirstSeen     LastSeen        Count   From                            SubobjectPath   Type            Reason                  Message</div><div class="line">  ---------     --------        -----   ----                            -------------   --------        ------                  -------</div><div class="line">  53s           53s             1       &#123;replicaset-controller &#125;                        Normal          SuccessfulCreate        Created pod: nginx-2040093540-iizoo</div></pre></td></tr></table></figure>
<p><code>kubectl describe quota --namespace=quota-example</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Name:           best-effort</div><div class="line">Namespace:      quota-example</div><div class="line">Scopes:         BestEffort</div><div class="line"> * Matches all pods that have best effort quality of service.</div><div class="line">Resource        Used    Hard</div><div class="line">--------        ----    ----</div><div class="line">pods            0       10</div><div class="line"></div><div class="line"></div><div class="line">Name:           compute-resources</div><div class="line">Namespace:      quota-example</div><div class="line">Resource        Used    Hard</div><div class="line">--------        ----    ----</div><div class="line">limits.cpu      200m    2</div><div class="line">limits.memory   512Mi   2Gi</div><div class="line">pods            1       4</div><div class="line">requests.cpu    100m    1</div><div class="line">requests.memory 256Mi   1Gi</div><div class="line"></div><div class="line"></div><div class="line">kubectl replace -f compute-resources.yaml  --namespace=quota-example</div><div class="line">resourcequota &quot;compute-resources&quot; replaced</div><div class="line">[root@cdsdev-radiant-0001 quota]# kubectl describe quota --namespace=quota-example</div><div class="line">Name:           best-effort</div><div class="line">Namespace:      quota-example</div><div class="line">Scopes:         BestEffort</div><div class="line"> * Matches all pods that have best effort quality of service.</div><div class="line">Resource        Used    Hard</div><div class="line">--------        ----    ----</div><div class="line">pods            0       10</div><div class="line"></div><div class="line"></div><div class="line">Name:           compute-resources</div><div class="line">Namespace:      quota-example</div><div class="line">Resource        Used    Hard</div><div class="line">--------        ----    ----</div><div class="line">limits.cpu      200m    4</div><div class="line">limits.memory   512Mi   4Gi</div><div class="line">pods            1       4</div><div class="line">requests.cpu    100m    2</div><div class="line">requests.memory 256Mi   2Gi</div></pre></td></tr></table></figure>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://ericculee.github.io/2016/08/02/scale-out-resource-vertically-by-resource-quota/" data-id="cj0dnea87000by1u0tkcj1ri9" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://ericculee.github.io/2016/08/02/scale-out-resource-vertically-by-resource-quota/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://ericculee.github.io/2016/08/02/scale-out-resource-vertically-by-resource-quota/">Comments</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
</section>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 Eric Li<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
        this.page.identifier = 'undefined';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'cuericlee' + '.disqus.com/count.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>