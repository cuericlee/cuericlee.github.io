<!doctype html>




<html class="theme-next " lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


















<link href="/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="//main.css?v=" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="kubernetes,availability,zone,ubernetes,container," />













<meta name="description" content="Abstract
Multiple zone minion nodes share the same master node (api server, etcd and etc). Need to seriously considering the high availability of master node. Nodes is labeled by different zone and fa">
<meta property="og:type" content="article">
<meta property="og:title" content="Research on Ubernetes (High availability zone) and federation clusters for Kubernetes">
<meta property="og:url" content="http://ericculee.github.io/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/index.html">
<meta property="og:site_name" content="Eric Li's Blog">
<meta property="og:description" content="Abstract
Multiple zone minion nodes share the same master node (api server, etcd and etc). Need to seriously considering the high availability of master node. Nodes is labeled by different zone and fa">
<meta property="og:updated_time" content="2017-03-17T08:43:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Research on Ubernetes (High availability zone) and federation clusters for Kubernetes">
<meta name="twitter:description" content="Abstract
Multiple zone minion nodes share the same master node (api server, etcd and etc). Need to seriously considering the high availability of master node. Nodes is labeled by different zone and fa">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: '',
    sidebar: "",
    fancybox: ,
    motion: ,
    duoshuo: {
      userId: 'undefined',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: "",
      labels: ""
    }
  };
</script>







  <title> Research on Ubernetes (High availability zone) and federation clusters for Kubernetes | Eric Li's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-81414009-1', 'auto');
  ga('send', 'pageview');
</script>









  
  

  <div class="container one-collumn  page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Eric Li's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://ericculee.github.io/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Eric Li">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Eric Li's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Eric Li's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Research on Ubernetes (High availability zone) and federation clusters for Kubernetes
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><ol>
<li><p>Multiple zone minion nodes share the same master node (api server, etcd and etc). Need to seriously considering the high availability of master node. Nodes is labeled by different zone and failure-domain to allow distribute workload across zones.</p>
</li>
<li><p>PV Affinity is used for zone awareness. But PV affinity is not ready. Most cloud providers (at least GCE and AWS) cannot attach their persistent volumes across zones.  Thus when a pod is being scheduled, if there is a volume<br>attached, that will dictate the zone.  This will be implemented using a new<br>scheduler predicate (a hard constraint): <code>VolumeZonePredicate</code>.<br>The PV is also labeled with the zone &amp; region it was created in. For version 1.3.4, dynamic persistent volumes are always created in the zone of the cluster master (here us-central1-a / us-west-2a); this will be improved in a future version (issue #23330.).   </p>
</li>
<li><p>Current kube-up.sh scripts depends on kube-up/kube-down/kube-push implementation and SDK of cloudprovider. gce and aws are supported well, but not for other cloudprovider today. (v1.3.4)</p>
</li>
<li><p>Alternative solution to setup an multiple availability zone with simple cloudprovider ubuntu/centos.</p>
<p> 4.1 Key spec</p>
<ul>
<li>share etcd</li>
<li>share flannel network</li>
<li>share docker registry</li>
<li><p>share apiserver. MASTER_INTERNAL_IP=172.20.0.9</p>
<p>4.2 Solution</p>
<blockquote>
<p>Create VM firslty, then kube-up.sh an ubuntu (centos) worker only to reuse the same master.</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<h3 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h3><pre><code>pip install --upgrade aws-cli
</code></pre><h3 id="Init-install"><a href="#Init-install" class="headerlink" title="Init install"></a>Init install</h3><pre><code>curl -sS https://get.k8s.io | MULTIZONE=true KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2 NUM_NODES=1 bash
</code></pre><h3 id="Setup-an-multizone-cluster-on-aws"><a href="#Setup-an-multizone-cluster-on-aws" class="headerlink" title="Setup an multizone cluster on aws"></a>Setup an multizone cluster on aws</h3><ol>
<li><p>Setup 1 node from zone us-west-2</p>
<pre><code>MULTIZONE=true KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2a NUM_NODES=1 ./cluster/kube-up.sh
</code></pre></li>
<li><p>Add 1 node cluster from zone us-west-2a</p>
<pre><code>KUBE_USE_EXISTING_MASTER=true MULTIZONE=true KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2b NUM_NODES=1 KUBE_SUBNET_CIDR=172.20.1.0/24 MASTER_INTERNAL_IP=172.20.0.9 kubernetes/cluster/kube-up.sh
</code></pre></li>
<li><p>Nodes labels for availability zone</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubectl get nodes --show-labels</div><div class="line">NAME                                         STATUS     AGE       LABELS</div><div class="line">ip-172-20-0-31.us-west-2.compute.internal    NotReady   2d        beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.micro,beta.kubernetes.io/os=linux,failure-domain.beta.kubernetes.io/region=us-west-2,failure-domain.beta.kubernetes.io/zone=us-west-2a,kubernetes.io/hostname=ip-172-20-0-31.us-west-2.compute.internal</div><div class="line">ip-172-20-1-138.us-west-2.compute.internal   Ready      2d        beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.micro,beta.kubernetes.io/os=linux,failure-domain.beta.kubernetes.io/region=us-west-2,failure-domain.beta.kubernetes.io/zone=us-west-2b,kubernetes.io/hostname=ip-172-20-1-138.us-west-2.compute.internal</div></pre></td></tr></table></figure>
<h3 id="Create-PV-with-zone-affinity-provisioned-at-zone-of-master-node"><a href="#Create-PV-with-zone-affinity-provisioned-at-zone-of-master-node" class="headerlink" title="Create PV with zone affinity, provisioned at zone of master node"></a>Create PV with zone affinity, provisioned at zone of master node</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">kubectl create -f - &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  "kind": "PersistentVolumeClaim",</div><div class="line">  "apiVersion": "v1",</div><div class="line">  "metadata": &#123;</div><div class="line">    "name": "claim1",</div><div class="line">    "annotations": &#123;</div><div class="line">        "volume.alpha.kubernetes.io/storage-class": "foo"</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "spec": &#123;</div><div class="line">    "accessModes": [</div><div class="line">      "ReadWriteOnce"</div><div class="line">    ],</div><div class="line">    "resources": &#123;</div><div class="line">      "requests": &#123;</div><div class="line">        "storage": "1Gi"</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NAME                                       CAPACITY   ACCESSMODES   STATUS    CLAIM            REASON    AGE       LABELS</div><div class="line">pvc-feb20d75-593a-11e6-afe8-06d12fd78863   1Gi        RWO           Bound     default/claim1             42s       failure-domain.beta.kubernetes.io/region=us-west-2,failure-domain.beta.kubernetes.io/zone=us-west-2a</div></pre></td></tr></table></figure>
<h3 id="Destroy-multiple-zone-cluster"><a href="#Destroy-multiple-zone-cluster" class="headerlink" title="Destroy multiple-zone cluster"></a>Destroy multiple-zone cluster</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">KUBERNETES_PROVIDER=aws KUBE_USE_EXISTING_MASTER=true KUBE_AWS_ZONE=us-west-2b kubernetes/cluster/kube-down.sh</div><div class="line">KUBERNETES_PROVIDER=aws KUBE_AWS_ZONE=us-west-2a kubernetes/cluster/kube-down.sh</div></pre></td></tr></table></figure>
<h3 id="Multiple-cluster-management"><a href="#Multiple-cluster-management" class="headerlink" title="Multiple cluster management"></a>Multiple cluster management</h3><p><a href="http://kubernetes.io/docs/admin/federation/" target="_blank" rel="external">Federation panel</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#Mandatory to build your own federation images with source code </div><div class="line">FEDERATION=true KUBE_RELEASE_RUN_TESTS=n make quick-release</div><div class="line"></div><div class="line">FEDERATION=true FEDERATION_PUSH_REPO_BASE=&lt;Your private registry&gt; ./build/push-federation-images.sh</div><div class="line"></div><div class="line">#Setup federation container, dns, router, lb, kubeconfig and federation namespace</div><div class="line"></div><div class="line">GOROOT=/root/go KUBE_ROOT=/root/k8s/src/k8s.io/kubernetes KUBERNETES_PROVIDER=aws DNS_ZONE_NAME=myfederation.aws FEDERATION_NAME=myfederation FEDERATION_PUSH_REPO_BASE=&lt;your private registry&gt; /root/k8s/src/k8s.io/kubernetes/federation/cluster/federation-up.sh</div><div class="line"></div><div class="line"></div><div class="line">GOROOT=/root/go KUBE_ROOT=/root/k8s/src/k8s.io/kubernetes KUBERNETES_PROVIDER=aws DNS_ZONE_NAME=myfederation.aws FEDERATION_NAME=myfederation FEDERATION_PUSH_REPO_BASE=&lt;your private registry&gt; /root/k8s/src/k8s.io/kubernetes/federation/cluster/federation-down.sh</div><div class="line"></div><div class="line">service &quot;federation-apiserver&quot; deleted</div><div class="line">secret &quot;default-token-k6v8j&quot; deleted</div><div class="line">secret &quot;federation-apiserver-kubeconfig&quot; deleted</div><div class="line">namespace &quot;federation&quot; deleted</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
            <a href="/tags/availability/" rel="tag"># availability</a>
          
            <a href="/tags/zone/" rel="tag"># zone</a>
          
            <a href="/tags/ubernetes/" rel="tag"># ubernetes</a>
          
            <a href="/tags/container/" rel="tag"># container</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/02/scale-out-resource-vertically-by-resource-quota/" rel="next" title="Scale out resource vertically by resource quota">
                <i class="fa fa-chevron-left"></i> Scale out resource vertically by resource quota
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/08/25/Performance-Tuning-of-Spark-ML-Job/" rel="prev" title="Performance Tuning of Spark ML Job">
                Performance Tuning of Spark ML Job <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/avatar.gif"
               alt="Eric Li" />
          <p class="site-author-name" itemprop="name">Eric Li</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eric Li</span>
</div>



        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="//jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="//fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="//jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="//velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="//velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script type="text/javascript" src="//src/utils.js?v="></script>

  <script type="text/javascript" src="//src/motion.js?v="></script>



  
  


  <script type="text/javascript" src="//src/affix.js?v="></script>

  <script type="text/javascript" src="//src/schemes/pisces.js?v="></script>



  
  <script type="text/javascript" src="//src/scrollspy.js?v="></script>
<script type="text/javascript" src="//src/post-details.js?v="></script>



  


  <script type="text/javascript" src="//src/bootstrap.js?v="></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'cuericlee';
      var disqus_identifier = '2016/08/05/Research-on-High-availability-zone-and-federation-clusters-for-Kubernetes/';

      var disqus_title = "Research on Ubernetes (High availability zone) and federation clusters for Kubernetes";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  





  
  

  

  

  

  


</body>
</html>
